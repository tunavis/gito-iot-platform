name: Reset Staging Database

# MANUAL TRIGGER ONLY - Use this to reset staging database to clean state
on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "RESET" to confirm database deletion'
        required: true
        type: string

jobs:
  reset-database:
    name: Reset Staging Database
    runs-on: self-hosted

    steps:
      - name: Validate Confirmation
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "RESET" ]; then
            echo "âŒ Confirmation failed. You must type 'RESET' to proceed."
            exit 1
          fi
          echo "âœ… Confirmation validated"

      - name: Display Warning
        run: |
          echo "ğŸš¨ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸš¨   STAGING DATABASE RESET"
          echo "ğŸš¨ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âš ï¸  This will:"
          echo "    â€¢ Stop all services"
          echo "    â€¢ Drop gito_iot_staging database"
          echo "    â€¢ Recreate database from scratch"
          echo "    â€¢ Run all Alembic migrations"
          echo "    â€¢ Delete ALL existing data"
          echo ""
          echo "â° Starting in 5 seconds..."
          sleep 5

      - name: Stop All Services
        run: |
          cd /opt/gito-iot
          echo "ğŸ›‘ Stopping all services..."
          docker compose -f docker-compose.staging.yml --env-file .env.staging down --remove-orphans || true
          docker rm -f gito-api-staging gito-web-staging gito-nginx-staging gito-postgres-staging gito-redis-staging 2>/dev/null || true
          echo "âœ… Services stopped"

      - name: Drop Database
        run: |
          cd /opt/gito-iot
          echo "ğŸ—‘ï¸  Dropping existing database..."

          # Start postgres
          docker compose -f docker-compose.staging.yml --env-file .env.staging up -d postgres
          sleep 10

          # Drop database (connect to postgres database to drop gito_iot_staging)
          docker exec gito-postgres-staging psql -U gito_user -d postgres -c "DROP DATABASE IF EXISTS gito_iot_staging;" || {
            echo "âš ï¸  Warning: Could not drop database (might not exist)"
          }

          echo "âœ… Database dropped"

      - name: Create Fresh Database
        run: |
          cd /opt/gito-iot
          echo "ğŸ†• Creating fresh database..."
          docker exec gito-postgres-staging psql -U gito_user -d postgres -c "CREATE DATABASE gito_iot_staging OWNER gito_user;"
          echo "âœ… Database created"

      - name: Run Alembic Migrations
        run: |
          cd /opt/gito-iot
          echo "ğŸ“¦ Running Alembic migrations..."

          # Start redis and API
          docker compose -f docker-compose.staging.yml --env-file .env.staging up -d redis
          sleep 5
          docker compose -f docker-compose.staging.yml --env-file .env.staging up -d api
          sleep 15

          echo "ğŸ“‹ Current status:"
          docker exec gito-api-staging alembic current || echo "No migrations applied yet"

          echo ""
          echo "âš¡ Running alembic upgrade head..."
          docker exec gito-api-staging alembic upgrade head

          echo ""
          echo "ğŸ“‹ Final status:"
          docker exec gito-api-staging alembic current

          echo "âœ… Migrations completed"

      - name: Restart All Services
        run: |
          cd /opt/gito-iot
          echo "ğŸš€ Restarting all services..."

          # Stop API
          docker compose -f docker-compose.staging.yml --env-file .env.staging down

          # Start all services
          docker compose -f docker-compose.staging.yml --env-file .env.staging up -d

          sleep 15
          echo "âœ… Services restarted"

      - name: Health Check
        run: |
          cd /opt/gito-iot
          echo "ğŸ¥ Running health check..."

          MAX_RETRIES=5
          RETRY_COUNT=0

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost/api/health)

            if [ "$HTTP_CODE" == "200" ]; then
              echo "âœ… Health check PASSED (HTTP $HTTP_CODE)"
              break
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              echo "â³ Attempt $RETRY_COUNT/$MAX_RETRIES (HTTP $HTTP_CODE)"
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                sleep 10
              fi
            fi
          done

          if [ "$HTTP_CODE" != "200" ]; then
            echo "âŒ Health check FAILED"
            echo ""
            echo "ğŸ“‹ API Logs:"
            docker logs gito-api-staging --tail 100
            exit 1
          fi

      - name: Verify Database Schema
        run: |
          cd /opt/gito-iot
          echo "ğŸ“Š Verifying database schema..."

          echo ""
          echo "Tables created:"
          docker exec gito-postgres-staging psql -U gito_user -d gito_iot_staging -c "\dt" | head -50

          echo ""
          echo "Migration history:"
          docker exec gito-postgres-staging psql -U gito_user -d gito_iot_staging -c "SELECT version_num FROM alembic_version;" || echo "No migration history table"

      - name: Summary
        run: |
          cd /opt/gito-iot
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… DATABASE RESET COMPLETE!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“Š Service Status:"
          docker compose -f docker-compose.staging.yml --env-file .env.staging ps
          echo ""
          echo "ğŸ¯ Next Steps:"
          echo "  1. âœ… Database is clean with all migrations applied"
          echo "  2. ğŸ” Create admin user or import test data"
          echo "  3. ğŸ§ª Test login at https://dev-iot.gito.co.za"
          echo "  4. ğŸ“Š Optional: Run ./scripts/import_to_staging.sh"
          echo ""
