name: Deploy to Staging

# Triggers on push to staging branch
on:
  push:
    branches:
      - staging  # Deploy when pushing to staging branch
  workflow_dispatch:  # Allow manual trigger

env:
  REGISTRY: ghcr.io
  IMAGE_NAME_API: ${{ github.repository }}-api
  IMAGE_NAME_WEB: ${{ github.repository }}-web

jobs:
  build-and-push:
    name: Build and Push Docker Images
    runs-on: self-hosted  # Use self-hosted runner
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for API
        id: meta-api
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_API }}
          tags: |
            type=raw,value=staging
            type=sha,prefix=staging-

      - name: Build and push API image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./api/Dockerfile
          push: true
          tags: ${{ steps.meta-api.outputs.tags }}
          labels: ${{ steps.meta-api.outputs.labels }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME_API }}:staging
          cache-to: type=inline

      - name: Extract metadata for Web
        id: meta-web
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_WEB }}
          tags: |
            type=raw,value=staging
            type=sha,prefix=staging-

      - name: Build and push Web image
        uses: docker/build-push-action@v5
        with:
          context: ./web
          push: true
          tags: ${{ steps.meta-web.outputs.tags }}
          labels: ${{ steps.meta-web.outputs.labels }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME_WEB }}:staging
          cache-to: type=inline

  deploy-staging:
    name: Deploy to Staging Server
    runs-on: self-hosted
    needs: build-and-push

    steps:
      - name: Pull Latest Code
        run: |
          cd /opt/gito-iot
          echo "üì• Pulling latest code..."
          git fetch origin
          git reset --hard origin/staging
          echo "‚úÖ Code updated"

      - name: Login to Container Registry
        env:
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
        run: |
          cd /opt/gito-iot
          echo "üîê Logging into GitHub Container Registry..."
          if [ -z "$GHCR_TOKEN" ]; then
            echo "‚ùå ERROR: GHCR_TOKEN secret not set!"
            echo "Go to: https://github.com/${{ github.repository }}/settings/secrets/actions"
            exit 1
          fi
          echo "$GHCR_TOKEN" | docker login ghcr.io -u tunavis --password-stdin
          echo "‚úÖ Logged in"

      - name: Pull Docker Images
        run: |
          cd /opt/gito-iot
          echo "üì¶ Pulling latest Docker images..."
          docker compose -f docker-compose.staging.yml --env-file .env.staging pull --ignore-buildable
          echo "‚úÖ Images pulled"

      - name: Build Local Images
        run: |
          cd /opt/gito-iot
          echo "üî® Building processor and mqtt-bridge images..."
          docker compose -f docker-compose.staging.yml --env-file .env.staging build processor mqtt-bridge
          echo "‚úÖ Local images built"

      - name: Stop Current Services
        run: |
          cd /opt/gito-iot
          echo "üõë Stopping current services..."
          docker compose -f docker-compose.staging.yml --env-file .env.staging down --remove-orphans || true
          echo "‚úÖ Services stopped (DB volume preserved)"

      - name: Start All Services
        run: |
          cd /opt/gito-iot
          echo "üöÄ Starting all services..."
          docker compose -f docker-compose.staging.yml --env-file .env.staging up -d
          echo "‚è≥ Waiting for services to start..."
          sleep 30
          echo "‚úÖ Services started"

      - name: Verify Migration
        run: |
          cd /opt/gito-iot
          echo "üìã Checking migration status..."
          docker exec gito-api-staging alembic current || echo "‚ö†Ô∏è Could not get migration status"
          echo "‚úÖ Migration verified"

      - name: Seed Database
        run: |
          cd /opt/gito-iot
          echo "üå± Seeding database..."
          docker exec -i gito-postgres-staging psql -U gito_user -d gito_iot_staging < scripts/seed.sql
          echo "‚úÖ Database seeded"

      - name: Health Check
        run: |
          cd /opt/gito-iot
          echo "üè• Running health check..."

          MAX_RETRIES=6
          RETRY_COUNT=0

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost/api/health)

            if [ "$HTTP_CODE" == "200" ]; then
              echo "‚úÖ Health check PASSED (HTTP $HTTP_CODE)"
              exit 0
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              echo "‚è≥ Attempt $RETRY_COUNT/$MAX_RETRIES (HTTP $HTTP_CODE)"
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                sleep 10
              fi
            fi
          done

          echo "‚ùå Health check FAILED after $MAX_RETRIES attempts"
          echo ""
          echo "üìã Service Status:"
          docker compose -f docker-compose.staging.yml --env-file .env.staging ps
          echo ""
          echo "üìã API Logs:"
          docker logs gito-api-staging --tail 100
          echo ""
          echo "üìã Web Logs:"
          docker logs gito-web-staging --tail 50
          echo ""
          echo "üìã Nginx Logs:"
          docker logs gito-nginx-staging --tail 50
          exit 1

      - name: Cleanup
        if: success()
        run: |
          cd /opt/gito-iot
          echo "üßπ Cleaning up old images..."
          docker image prune -af --filter "until=24h"
          echo "‚úÖ Cleanup complete"

      - name: Deployment Summary
        if: success()
        run: |
          cd /opt/gito-iot
          echo ""
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "‚úÖ DEPLOYMENT SUCCESSFUL!"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo ""
          echo "üìä Service Status:"
          docker compose -f docker-compose.staging.yml --env-file .env.staging ps
          echo ""
          echo "üåê Application: https://dev-iot.gito.co.za"
          echo "üè• Health: https://dev-iot.gito.co.za/api/health"
          echo ""
